# v0.3.4-recommendation-rule-tuner

推奨ロジックを「コード」から「設定」に昇格。ダッシュボードを見ながら YAML を調整 → 即反映。

## Added

### recommendation_rules.yaml

ルール定義を YAML で外出し:

```yaml
version: "1.0"

rules:
  - id: R1_COMPLETED_NOOP
    priority: 10
    when:
      status: completed
      passed: true
    recommend: noop

  - id: R2_TIMEOUT_RETRY
    priority: 20
    when:
      status: failed
      error_code: TIMEOUT
    recommend: retry

  - id: R3_MCP_CALL_RERUN
    priority: 30
    when:
      status: failed
      error_stage: mcp_call
      error_code: "!TIMEOUT"
    recommend: rerun

  # ... 以下省略
```

### 条件の記法

| 記法 | 意味 | 例 |
|------|------|-----|
| `"value"` | 完全一致 | `error_code: TIMEOUT` |
| `"!value"` | 否定 | `error_code: "!TIMEOUT"` |
| `">N"` | 大なり | `changes: ">0"` |
| `">=N"` | 大なりイコール | `changes: ">=1"` |
| `true/false` | bool | `passed: true` |

### recommendation_engine.py

YAML ベースのルールエンジン:

- `load_rules()`: YAML からルール読み込み、priority 順ソート
- `validate_rules()`: 必須キー、ID/priority 重複、recommend 値チェック
- `determine_recommendation()`: 上から評価、最初にマッチしたルールを採用

### バリデーション

| チェック | エラー時 |
|----------|---------|
| 必須キー（id, priority, when, recommend） | RuleValidationError |
| id 重複 | RuleValidationError |
| priority 重複 | RuleValidationError |
| recommend が無効値 | RuleValidationError |

### テスト追加

33 テストを追加:

- バリデーション（8 テスト）
- 条件評価（8 テスト）
- ルール評価（5 テスト）
- 推奨決定（6 テスト）
- YAML 変更効果（3 テスト）
- デフォルトルール（3 テスト）

## 使い方

1. `/learning` ダッシュボードで改善ターゲットを特定
2. `config/recommendation_rules.yaml` を編集
3. priority や条件を調整
4. relay_api を再起動（設定反映）
5. 新しい run で新ルールが適用される

## 効果

| Before | After |
|--------|-------|
| ルール変更 = コード変更 | YAML 編集のみ |
| デプロイ必須 | 再起動で反映 |
| テスト修正が必要 | 既存テストはそのまま |

## Commits

### infra-automation
- `9f654af` feat(recommendation): externalize rules to YAML (v0.3.4)
