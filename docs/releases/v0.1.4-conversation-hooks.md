# v0.1.4-conversation-hooks

ai_dispatch.py の全プロバイダー（5種）に会話ログフックを追加。

## Added

### infra-automation

- **tools/conversation_hook.py**: 外部AI呼び出しのロギングフック
  - `with_conversation_log()`: ハンドラ呼び出しをラップしてログ記録
  - `create_logged_handler()`: プロバイダー固有ハンドラのラップ関数生成
  - `set_run_id()` / `get_run_id()`: スレッドローカルで run_id 管理

- **tools/ai_dispatch.py**: PROVIDER_HANDLERS をログ付きハンドラでラップ
  - `call_openai` → ログ付き
  - `call_anthropic` → ログ付き
  - `call_google` → ログ付き
  - `call_deepseek` → ログ付き
  - `call_xai` → ログ付き

## イベント形式

```jsonl
{"ts":"...","role":"system","source":"ai_dispatch.openai","event":"external_ai.request","meta":{"model":"gpt-4o"}}
{"ts":"...","role":"system","source":"ai_dispatch.openai","content":"システムプロンプト"}
{"ts":"...","role":"user","source":"ai_dispatch.openai","content":"ユーザープロンプト"}
{"ts":"...","role":"assistant","source":"ai_dispatch.openai","content":"レスポンス"}
{"ts":"...","role":"system","source":"ai_dispatch.openai","event":"external_ai.response","meta":{"status":"ok"}}
```

エラー時:
```jsonl
{"ts":"...","role":"system","source":"ai_dispatch.openai","event":"external_ai.error","meta":{"status":"error","error_type":"ValueError","error_message":"..."}}
```

## 使い方

```python
from tools.conversation_hook import set_run_id

# タスク実行前に run_id をセット
set_run_id("run-xxxx")

# dispatch() を呼ぶと自動でログ記録
result = dispatch("coding", "このコードをレビューして")
```

## 設計判断

- **選択: 各 call_* を個別にフック（Option A）**
- 理由: v0.1.3 の価値は「なぜそうなったか」を残すこと。詳細度を落とすと目的が崩れる
- 実装: `create_logged_handler()` で共通ラッパー作成 → 5行で全プロバイダー対応

## v0.1.3 との関係

| バージョン | 対象 | スコープ |
|-----------|------|---------|
| v0.1.3 | openai_adapter.py | product_pipeline のみ |
| v0.1.4 | ai_dispatch.py | 全外部AI呼び出し（5プロバイダー） |

## Commits

### infra-automation
- `626ff3f` feat(conversation): add hooks for all ai_dispatch providers

### ai-update-radar
- `020c28d` docs: add v0.1.4-conversation-hooks release notes
