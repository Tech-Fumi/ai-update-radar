# v0.3.6-learning-check-notification

学習統計の日次チェック＆Discord 通知（Phase1: 採用率ベース）。

## Added

### check-learning-stats.sh

日次で `/learning/stats?since=24h` をチェックし、状態に応じて Discord 通知。

**判定ロジック:**

| 状態 | 条件 | 通知 |
|------|------|:----:|
| GOOD | R2 採用率 >= 80% かつ mismatch <= 3 | ✅ |
| BAD | R2 採用率 < 50% または mismatch >= 10 | ✅ |
| INFO | その他 | ❌ |

**Phase1 の制約:**
- `採用率`（acceptance rate）を使用
- `成功率`（success rate）は未実装（outcome_link 必要）

### systemd タイマー

```
check-learning-stats.timer: 毎日 04:00 に実行
check-learning-stats.service: oneshot で通知スクリプト実行
```

**環境変数:**

| 変数 | デフォルト | 説明 |
|------|-----------|------|
| RELAY_URL | 必須 | http://localhost:8050 |
| DISCORD_WEBHOOK_URL | 必須 | ~/.env から読み込み |
| SINCE | 24h | 集計期間 |
| GOOD_RATE | 0.80 | GOOD 判定閾値 |
| BAD_RATE | 0.50 | BAD 判定閾値 |

## 有効化手順

```bash
# シンボリックリンク作成
sudo ln -sf /home/fumi/infra-automation/claude-relay-bridge/systemd/check-learning-stats.service /etc/systemd/system/
sudo ln -sf /home/fumi/infra-automation/claude-relay-bridge/systemd/check-learning-stats.timer /etc/systemd/system/

# リロード＆有効化
sudo systemctl daemon-reload
sudo systemctl enable --now check-learning-stats.timer

# 確認
systemctl list-timers check-learning-stats.timer
```

## 手動テスト

```bash
# 環境変数を設定して実行
export RELAY_URL=http://localhost:8050
export DISCORD_WEBHOOK_URL="..."
export SINCE=24h
/home/fumi/infra-automation/scripts/check-learning-stats.sh
```

## Phase2 予定

outcome_link を実装後:
- 採用率 → 成功率（実際の結果ベース）
- 精度が上がり、ON 判断の根拠が強化される

## Commits

### infra-automation
- `9ec98ce` feat(relay): add Phase1 learning stats Discord notification
