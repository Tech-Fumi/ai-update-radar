# v0.1.6-conversation-limits

会話ログの容量制御（content truncation）機能。

## Added

### infra-automation

- **conversation_logger.py**: 容量制御機能
  - `_truncate_content()`: content が max_bytes を超えたら truncate
  - `append_conversation()` に `max_content_bytes` パラメータ追加
  - デフォルト: 256KB/content、1000文字プレビュー

## 動作

content が 256KB を超えた場合:

1. 元の content の SHA256 を計算（`sha256_full_content`）
2. 先頭 1000 文字をプレビューとして保持
3. `meta.content_truncated = true` を付与

## 出力例

```jsonl
{
  "ts": "...",
  "role": "assistant",
  "source": "ai_dispatch.openai",
  "content": "This is the preview of the response... [truncated: 350000 chars total]",
  "meta": {
    "content_truncated": true,
    "sha256_full_content": "abc123...",
    "original_bytes": 358400,
    "preview_chars": 1000
  }
}
```

## 設定

| 設定 | デフォルト | 説明 |
|------|-----------|------|
| `DEFAULT_MAX_CONTENT_BYTES` | 256KB | content の最大バイト数 |
| `DEFAULT_PREVIEW_CHARS` | 1000 | プレビューとして残す文字数 |

## 処理順序

```
1. ts 付与
2. content truncation (v0.1.6) ← NEW
3. secrets masking (v0.1.5)
4. ファイル書き込み
```

truncate → mask の順序により:
- sha256_full_content は truncate 前の元データのハッシュ
- マスクはプレビュー部分のみに適用（効率的）

## 効果

| before | after |
|--------|-------|
| 巨大プロンプト/レスポンスでディスク肥大 | 一定サイズ以下に抑制 |
| 元データの同一性が不明 | sha256 で「同じ or 違う」を判定可能 |

## Commits

### infra-automation
- `a58abc5` feat(conversation): add content truncation for size control
