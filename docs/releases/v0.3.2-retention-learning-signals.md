# v0.3.2-retention-learning-signals

learning_signals.jsonl の寿命管理を追加。肥大化しても安全に回り、壊れたら検知できる。

## Added

### cleanup-learning-signals.sh

30日以上古いエントリを削除:

```bash
# ドライラン（削除せずに確認）
./scripts/cleanup-learning-signals.sh 30 --dry-run

# 実行
./scripts/cleanup-learning-signals.sh 30
```

| パラメータ | デフォルト | 説明 |
|-----------|-----------|------|
| RETENTION_DAYS | 30 | 保持日数 |
| MAX_LINES | 100,000 | 最大行数（超過時は古い順に削除） |

安全ガード:
- パス検証（logs/ 配下のみ）
- バックアップ自動作成（.bak）
- --dry-run オプション

### verify-learning-signals.py

JSONL 整合性チェック:

```bash
# 検証のみ
./scripts/verify-learning-signals.py

# 壊れた行を除去
./scripts/verify-learning-signals.py --fix
```

チェック項目:
- JSON パース可能か
- 必須キー（ts, event_type）
- action_chosen: run_id, recommended, chosen
- outcome_link: parent_run_id, child_run_id, status

### systemd timer

毎日 04:00 JST に自動実行:

```bash
# インストール
sudo cp systemd/*.service systemd/*.timer /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable --now cleanup-learning-signals.timer

# 確認
systemctl list-timers cleanup-*
```

## 効果

| Before | After |
|--------|-------|
| signals が増え続ける | 30日でローテーション |
| 壊れても気づかない | verify で検知 |
| 手動 cleanup | 自動（daily timer） |

## Commits

### infra-automation
- `6d2a75e` feat(scripts): add learning signals retention management (v0.3.2)
