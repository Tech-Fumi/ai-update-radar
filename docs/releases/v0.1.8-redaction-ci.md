# v0.1.8-redaction-ci

secrets_masker の CI テスト追加。会話ログ機能の"守り"を完成。

## Added

### claude-relay-bridge/tests/test_secrets_masker.py

- **TestMaskSecrets**: 17カテゴリのゴールデンテスト
- **TestNoMasking**: マスクされるべきでないケース
- **TestMaskDictValues**: 辞書/リスト処理のテスト
- **TestLeakDetection**: 漏れ検知テスト（最重要）
- **TestRedactionVersion**: バージョン管理テスト

## テストカテゴリ

| # | カテゴリ | パターン | テスト数 |
|---|---------|---------|:--------:|
| 1 | OpenAI API Key | sk-*, sk-proj-* | 2 |
| 2 | Anthropic API Key | sk-ant-* | 1 |
| 3 | AWS Access Key | AKIA* | 1 |
| 4 | AWS Secret Key | aws_secret_access_key=* | 1 |
| 5 | Slack Token | xox[baprs]-* | 2 |
| 6 | GitHub Token | ghp_/ghs_/github_pat_* | 3 |
| 7 | Google API Key | AIza* | 1 |
| 8 | Discord Token | base64.base64.base64 | 1 |
| 9 | JWT | eyJ*.eyJ*.* | 1 |
| 10 | Private Key | PEM format | 1 |
| 11 | Auth Header | Authorization: Bearer/Basic | 2 |
| 12 | Env Secret | KEY=value pattern | 2 |
| 13 | DB Connection | mongodb/postgres/redis:// | 4 |
| 14 | Internal IP | 192.168.*/172.16-31.* | 2 |
| 15 | Credit Card | Visa/Mastercard | 2 |
| 16 | JP Phone | 090/080/070-* | 2 |
| 17 | My Number | 1234-5678-9012 | 2 |

## 漏れ検知テスト

```python
class TestLeakDetection:
    """入力にシークレットを含め、出力に残っていたら FAIL"""

    def test_comprehensive_leak_check(self):
        # 全シグネチャを含む入力 → マスク後に何も残っていない
        for sig, desc in LEAK_SIGNATURES:
            assert sig not in masked, f"{desc} leaked"
```

**シグネチャ一覧:**
- `sk-`, `sk-proj-`, `sk-ant-`
- `AKIA`, `xoxb-`, `xoxp-`
- `ghp_`, `ghs_`, `AIza`
- `eyJ`, `BEGIN PRIVATE KEY`

## 実行方法

```bash
cd claude-relay-bridge
.venv/bin/python -m pytest tests/test_secrets_masker.py -v
```

## 結果

```
47 passed, 1 skipped in 0.08s
```

**Skipped:** `test_internal_ip_10` - 10.x.x.x パターンにバグあり（TODO）

## Done 定義

- [x] 全17カテゴリのゴールデンテスト
- [x] 漏れ検知テスト（sk-* 等が残っていたら FAIL）
- [x] pytest で実行可能

## 会話ログ機能 完成

v0.1.4〜v0.1.8 で会話ログ機能が完成:

| Version | 機能 |
|---------|------|
| v0.1.4 | 全5プロバイダーをフック |
| v0.1.5 | シークレット/PII マスキング |
| v0.1.6 | 容量制御（256KB上限） |
| v0.1.7 | 検索・フィルタ機能 |
| v0.1.8 | CI テスト（守り完成） |

## Commits

### infra-automation
- `ab5e6d7` test(secrets-masker): add golden tests and leak detection (v0.1.8)
