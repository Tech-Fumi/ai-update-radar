# v0.3.5-auto-action-policy

TIMEOUT 自動リトライを YAML ポリシーで定義。安全装置付きで「押す」を自動化。

## Added

### auto_action_policy.yaml

ポリシー定義:

```yaml
version: "1.0"

global:
  enabled: false      # まず false で開始
  dry_run: true       # dry_run で観測
  kill_switch_env: AUTO_ACTION_DISABLED

policies:
  - id: P1_AUTO_RETRY_TIMEOUT
    enabled: true
    when:
      recommendation_reason: R2_TIMEOUT_RETRY
    action: retry
    guards:
      max_depth: 1         # 自動リトライは1回まで
      max_per_hour: 10     # 時間あたり上限
      exclude_prefix: "tr_autoretry_"
```

### ガード（暴走防止）

| ガード | 説明 |
|--------|------|
| `max_depth` | trace_id に autoretry が含まれていたら停止 |
| `max_per_hour` | 直近1時間のカウントで上限 |
| `kill_switch_env` | 環境変数 `true` で即停止 |
| `dry_run` | ログのみ、実行しない |

### auto_action_engine.py

ポリシー評価エンジン:

- `load_policy()`: YAML からポリシー読み込み
- `check_kill_switch()`: kill-switch チェック
- `check_max_depth()`: 再帰深度チェック
- `check_max_per_hour()`: 時間あたり上限チェック
- `evaluate_auto_action()`: 総合評価、learning_signals に記録

### learning_signals 連携

自動アクションは `source: "auto"` で記録:

```json
{
  "event_type": "action_chosen",
  "action": {
    "run_id": "r_123",
    "recommended": "retry",
    "chosen": "retry",
    "source": "auto",
    "policy_id": "P1_AUTO_RETRY_TIMEOUT",
    "dry_run": true
  }
}
```

### テスト

26 テストを追加:

- ポリシー読み込み（2 テスト）
- kill-switch（4 テスト）
- max_depth（4 テスト）
- max_per_hour（4 テスト）
- ポリシーマッチング（3 テスト）
- 記録（1 テスト）
- 統合テスト（6 テスト）
- デフォルトポリシー（2 テスト）

## 有効化手順

1. **観測フェーズ（現在）**
   ```yaml
   global:
     enabled: false
     dry_run: true
   ```
   - ログのみ出力、実行しない
   - `/learning` で dry_run: true のエントリを確認

2. **dry-run フェーズ**
   ```yaml
   global:
     enabled: true
     dry_run: true
   ```
   - ログに `[AutoAction] DRY-RUN:` が出る
   - 実際の retry は実行しない

3. **本番フェーズ**
   ```yaml
   global:
     enabled: true
     dry_run: false
   ```
   - TIMEOUT 失敗で自動 retry が走る

## 緊急停止

```bash
# 環境変数で即停止
export AUTO_ACTION_DISABLED=true
# または YAML で
# global.enabled: false
```

## 効果

| Before | After |
|--------|-------|
| TIMEOUT → 手動で Retry ボタン | 自動 retry |
| コードで条件ハードコード | YAML で定義 |
| 暴走リスクあり | ガードで防止 |

## Commits

### infra-automation
- `858a454` feat(relay): integrate auto_action_engine into task result flow
- `182c0c1` feat(auto-action): add policy-based auto action engine (v0.3.5)
